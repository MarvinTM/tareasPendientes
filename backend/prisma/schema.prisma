generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(uuid())
  googleId   String   @unique
  email      String   @unique
  name       String
  shortName  String?
  color      String?
  picture    String?
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())

  tasksCreated  Task[]         @relation("TaskCreator")
  tasksAssigned Task[]         @relation("TaskAssignee")
  taskChanges   TaskHistory[]
  periodicTasks PeriodicTask[] @relation("PeriodicTaskAssignee")
}

model Task {
  id           String     @id @default(uuid())
  title        String
  description  String?
  status       TaskStatus @default(Nueva)
  size         TaskSize   @default(Pequena)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  completedAt  DateTime?
  createdById  String
  createdBy    User       @relation("TaskCreator", fields: [createdById], references: [id])
  assignedToId String?
  assignedTo   User?      @relation("TaskAssignee", fields: [assignedToId], references: [id])
  categoryId   String?
  category     Category?  @relation(fields: [categoryId], references: [id])
  periodicTaskId String?
  periodicTask PeriodicTask? @relation(fields: [periodicTaskId], references: [id], onDelete: SetNull)

  history TaskHistory[]
}

model PeriodicTask {
  id           String    @id @default(uuid())
  title        String
  description  String?
  size         TaskSize  @default(Pequena)
  frequency    Frequency
  dayOfWeek    Int? // 0-6 (Sunday-Saturday)
  monthOfYear  Int? // 0-11 (Jan-Dec)
  activeFromMonth Int? // 0-11 (Jan-Dec), null = all year
  activeToMonth   Int? // 0-11 (Jan-Dec), null = all year
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  categoryId   String
  category     Category  @relation(fields: [categoryId], references: [id])
  assignedToId String?
  assignedTo   User?     @relation("PeriodicTaskAssignee", fields: [assignedToId], references: [id])
  lastGeneratedAt DateTime?
  generatedTasks Task[]
}

model Category {
  id            String         @id @default(uuid())
  name          String         @unique
  emoji         String
  createdAt     DateTime       @default(now())
  tasks         Task[]
  periodicTasks PeriodicTask[]
}

enum TaskStatus {
  Nueva
  EnProgreso
  Completada
}

enum TaskSize {
  Pequena
  Mediana
  Grande
}

enum Frequency {
  WEEKLY
  MONTHLY
}

model TaskHistory {
  id            String   @id @default(uuid())
  taskId        String
  task          Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  action        String
  previousValue String?
  newValue      String?
  timestamp     DateTime @default(now())
}

model SystemLog {
  id        String   @id @default(uuid())
  key       String   @unique
  timestamp DateTime @default(now())
}